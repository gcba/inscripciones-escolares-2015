function endall(e,t){var a=0;e.each(function(){++a}).each("end",function(){--a||t.apply(this,arguments)})}function showOneCirculito(){d3.selectAll("circle").attr("class",currentSeccion+" general"),$(".circulo").hide(),grupoCirculoMedio.style("display","block"),circuloMedio.attr("cx",posxMedio).attr("cy",posyMedio),circuloMedio.transition().duration(500).attr("r",circulo.radioGrande)}function hideOneCirculitoYJuntar(){circuloMedio.transition().duration(500).attr("r",circulo.radio).call(endall,function(){juntarCirculitos()})}function juntarCirculitos(){d3.selectAll("rect").transition().attr("x",function(e,t){return circulo.posx+(circulo.margin+circulo.radio)*(t%grillaSvg.columnasGeneral+1)-circulo.radio-(circulo.margin-circulo.radio)/2}).attr("y",function(e,t){return circulo.posy+(circulo.margin+circulo.radio)*(Math.floor(t/grillaSvg.columnasGeneral)+1)-circulo.radio-(circulo.margin-circulo.radio)/2}),d3.selectAll("circle").transition(500).ease("quad-in").attr("cx",function(e,t){return circulo.posx+(circulo.margin+circulo.radio)*(t%grillaSvg.columnasGeneral+1)}).transition(500).ease("quad-out").attr("cy",function(e,t){return circulo.posy+(circulo.margin+circulo.radio)*(Math.floor(t/grillaSvg.columnasGeneral)+1)}),d3.selectAll("circle").attr("class",currentSeccion+" general").attr("nivel","general")}function calcularPosxNivel(e,t){return e+((t+1)*(circulo.margin+circulo.radio)-(circulo.margin+circulo.radio)*grillaSvg.columnasPorNivel*Math.floor(t/grillaSvg.columnasPorNivel))}function calcularPosicionXComuna(e){var t=niveles[0].x0;return t+((e+1)*(circulo.margin+circulo.radio)-(circulo.margin+circulo.radio)*grillaSvg.columnasPorNivel*Math.floor(e/grillaSvg.columnasPorNivel))}function calcularPosyNivel(e){return grillaSvg.alto-grillaSvg.labelSpace-Math.floor(e/grillaSvg.columnasPorNivel)*(circulo.margin+circulo.radio)}function calcularNivel(e){for(var t=0,a=niveles[t].total;e>=a;)t++,a+=niveles[t].total;return t}function calcularNuevaPosicion(e,t){var a,l=calcularNivel(t),i=0;if(l>0)for(var n=l;n>0;)i+=niveles[n-1].total,n--;return currentIndex=t-i,"x"==e?(x0=niveles[l].x0,a=calcularPosxNivel(x0,currentIndex)):"y"==e?a=calcularPosyNivel(currentIndex):console.log("Hubo un error con el calculo de posiciones de los ejes X e Y"),a}function separarCirculitos(){var e=0,t=(niveles[e].total,0);d3.selectAll("circle").transition(1e3).delay(function(e,t){return.5*t}).ease("quad").attr("cx",function(e,t){return calcularNuevaPosicion("x",t)}).attr("cy",function(e,a){return t=0,calcularNuevaPosicion("y",a)}).call(endall,function(){d3.selectAll("rect").attr("x",function(){var e=$(this).parent().children("circle").attr("cx");return e-circulo.radio-(circulo.margin-circulo.radio)/2}).attr("y",function(){var e=$(this).parent().children("circle").attr("cy");return e-circulo.radio-(circulo.margin-circulo.radio)/2}),d3.selectAll("circle").attr("class",function(e,t){return currentSeccion+" nivel"+calcularNivel(t)+" general"}).attr("nivel",function(e,t){return calcularNivel(t)})})}function agregarNivelActivo(){var e=$("#dropdown-nivel select option:selected").val(),t=$("circle.nivel_activo");if(0!=t.length){var a=$("circle.nivel_activo").attr("class").replace(new RegExp("(\\s|^)nivel_activo(\\s|$)","g"),"$2");d3.selectAll("circle."+a.split(" ").join(".")+".nivel_activo").attr("class",a)}var l=$("g.labels text.nivel_activo");if(0!=l.length){var a=$("g.labels text.nivel_activo").attr("class").replace(new RegExp("(\\s|^)nivel_activo(\\s|$)","g"),"$2");d3.selectAll("g.labels text."+a.split(" ").join(".")+".nivel_activo").attr("class",a)}var i=$("g.info text.nivel_activo");if(0!=i.length){var a=$("g.info text.nivel_activo").attr("class").replace(new RegExp("(\\s|^)nivel_activo(\\s|$)","g"),"$2");d3.selectAll("g.info text."+a.split(" ").join(".")+".nivel_activo").attr("class",a)}var n=$("circle[nivel='"+e+"']"),r=n.attr("class");d3.selectAll(n).attr("class",r+" nivel_activo");var c=$("g.labels text[nivel='"+e+"']"),r=c.attr("class");d3.selectAll(c).attr("class",r+" nivel_activo");var o=$("g.info text[nivel='"+e+"']"),r=o.attr("class");d3.selectAll(o).attr("class",r+" nivel_activo")}function mostrarMapaComunas(){if(0==$("circle.nivel_activo").length){var e=$("circle[nivel='0']");d3.selectAll(e).attr("class","comuna nivel0 general nivel_activo");var t=$("g.labels text[nivel='0']");d3.selectAll(t).attr("class","comuna nivel0 general nivel_activo")}$(".circulo").hide(),$("circle.nivel_activo").parent().show(),d3.selectAll($("circle")).attr("cx",function(e,t){return calcularNuevaPosicion("x",t)}),d3.selectAll("rect").attr("x",function(){var e=$(this).parent().children("circle").attr("cx");return e-circulo.radio-(circulo.margin-circulo.radio)/2}),d3.selectAll("circle.nivel_activo").transition().attr("cx",function(e,t){return calcularPosicionXComuna(t)}).call(endall,function(){d3.selectAll("rect").attr("x",function(){var e=$(this).parent().children("circle").attr("cx");return e-circulo.radio-(circulo.margin-circulo.radio)/2})}),d3.select("#mapaCABA svg").transition().duration(400).attr("x",350);{var a=$("circle.nivel_activo").attr("nivel");$("#dropdown-nivel option[value='"+a+"']").attr("selected","selected")}nivelActivo=$("#dropdown-nivel :selected").text().toLowerCase(),$("g.labels").show();var l=$("g.labels text[nivel='"+a+"'] tspan.nivelLink")[0];d3.select(l).style("text-decoration","none").style("font-weight","normal").on("click",function(){}),$("g.labels text[nivel='"+a+"']").show(),d3.selectAll("g.labels text[nivel='"+a+"']").attr("x",function(){return niveles[0].x0+circulo.margin}),d3.selectAll("g.labels text[nivel='"+a+"'] tspan").attr("x",function(){return niveles[0].x0+circulo.margin}),$("tspan.nivelLink").removeAttr("x"),$("g.labels text:not([nivel='"+a+"'])").hide(),$("g.descripciones").show(),$("g.descripciones text[nivel='"+a+"']").show(),$("g.descripciones text:not([nivel='"+a+"'])").hide()}function resetRadios(){if($("li > input:radio[name='filtro']").is(":checked")){var e=$("input:radio[name='filtro']:checked"),t=(e.attr("previousValue"),$(".form-group li").find("svg:has(path)"));t&&t.children().remove(),e.removeAttr("checked"),e.attr("previousValue",!1)}}function resetCambioSeccion(){function e(){circuloMedio.attr("r",circulo.radio)}function t(){$("#mapaCABA").hide(),d3.select("#mapaCABA svg").attr("x",mapaSvg.posInicialX).attr("y",mapaSvg.posInicialY)}switch(resetRadios(),$("a.arrow").hide(),$("#bajada").animate({opacity:0}),currentSeccion=$("section.active").attr("id"),d3.selectAll("circle").transition().duration(500).attr("fill",colores.neutro),"comuna"!=currentSeccion&&(t(),$("#dropdown-nivel").hide(),$("g.descripciones").hide()),"niveles"!=currentSeccion&&($("g.labels").hide(),$("#radio-grados").parent().hide()),$("g.info").hide(),currentSeccion){case"landing":$(".filtro").hide();break;case"niveles":e();break;case"comuna":e(),nivelMapaCaba="inicial",$("svg").show();break;case"mapa":$("#viz-container").hide(),$("svg").hide(),$(".filtro").hide()}}function calcularLineas(e,t){t="undefined"==typeof t?infoDetails.palabrasPorLinea:t;for(var a=e.split(" "),l=[],i=0;i<a.length;i+=t){var n=a.slice(i,i+t),r=n.join(" ");l.push(r)}return l}function generarInfoTextLanding(){var e=explicativos.secciones.landing.estadoCero;infoGroup.append("text");for(var t=calcularLineas(e.general),a=parseInt(circuloMedio.attr("cx"))+circulo.radioGrande+2*circulo.margin,l=parseInt(circuloMedio.attr("cy"))-Math.floor(t.length/2)*infoDetails.verticalMargin,i=d3.select("g.info text").text(t[0]).attr("x",a).attr("y",l).attr("class",currentSeccion+" general").attr("nivel","general"),n=1;n<t.length;n++)i.append("tspan").text(t[n]).attr("x",a).attr("y",l+infoDetails.verticalMargin*n).attr("class",currentSeccion+" general").attr("nivel","general")}function generarInfoTextGeneral(e){var t=explicativos.secciones.general[e],a=Object.keys(t);infoGroup.selectAll("g.info text").data(a).enter().append("text");for(var l=0,i=0,n=0,r=a.length-1;r>=0;r--){var c="";c="preferencia"==e?calcularLineas(t[a[r]],5):calcularLineas(t[a[r]]),i=grillaSvg.columnasGeneral*(circulo.radio+circulo.margin)+circulo.posx+circulo.radio+2*circulo.margin,l="estadoCero"==e?grillaSvg.filasGeneral*(circulo.radio+circulo.margin)/2+circulo.posy+Math.floor(c.length/2)*infoDetails.verticalMargin:grillaSvg.filasGeneral*(circulo.radio+circulo.margin)+circulo.posy-n*infoDetails.verticalMargin;var o=d3.selectAll("g.info text").filter(function(e,t){return t==r});o.text(c[0]).attr("x",i).attr("y",l-(c.length-1)*infoDetails.verticalMargin).attr("class",currentSeccion+" "+a[r]).attr("nivel","general").on("mouseover",function(){var e=$(this).attr("class").split(" ").slice(0,2);d3.selectAll($("circle:not(."+e.join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+e.join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+e.join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)}),n++;for(var s=0,u=c.length-1;u>=1;u--)s=l-(c.length-u-1)*infoDetails.verticalMargin,o.append("tspan").text(c[u]).attr("x",i).attr("y",s).attr("class",currentSeccion+" "+a[r]).attr("nivel","general"),n++}}function generarInfoTextNiveles(e){var t=explicativos.secciones.niveles,a=Object.keys(t),l=0,i=0;if("estadoCero"==e){var n=labelsGroup.selectAll("text");0!=n.length&&labelsGroup.selectAll("text").remove(),labelsGroup.selectAll("text").data(a).enter().append("text");for(var r="",c=0;c<a.length;c++){r=t[a[c]][e].general;var o=calcularLineas(r),s=o[o.length-1].split(" "),u=s[s.length-1];l=coordenadasNiveles[c]+circulo.margin,i=grillaSvg.alto-grillaSvg.labelSpace+2*infoDetails.verticalMargin;var d=d3.selectAll("g.labels text").filter(function(e,t){return t==c});d.text(o[0]).attr("x",l).attr("y",i).attr("class",currentSeccion+" "+a[c]+" general").attr("nivel",c).on("mouseover",function(){var e=$(this).attr("class").split(" ").slice(0,2);d3.selectAll($("circle:not(."+e.join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+e.join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+e.join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)});for(var v=0,g="",p=1;p<o.length;p++){v=i+infoDetails.verticalMargin*p,g=o[p],p==o.length-1&&(g=o[p].split(" ").slice(0,2).join(" ")+" ");var f=d.append("tspan").text(g).attr("x",l).attr("y",v).attr("class",currentSeccion+" "+a[c]+" general animated fadeIn").attr("nivel",c);p==o.length-1&&f.append("tspan").text(u).attr("font-weight","bold").attr("text-decoration","underline").attr("class","nivelLink "+u).on("click",function(){$(".main").moveDown();var e=$(this).parent().attr("nivel"),t=$("circle[nivel='"+e+"']"),a=t.attr("class");d3.selectAll(t).attr("class",a+" nivel_activo")})}}}else{for(var x=[],h=[],c=0;c<a.length;c++){var m=t[a[c]][e],y=Object.keys(m);h.push(y);for(var p=0;p<y.length;p++)x.push(y[p])}infoGroup.selectAll("g.info text").data(x).enter().append("text");for(var A=grillaSvg.columnasPorNivel*(circulo.margin+2*circulo.radio),c=0;c<a.length;c++)for(var m=t[a[c]][e],y=Object.keys(m),b=0,p=0;p<y.length;p++){var o=[];o="procedencia"==e?calcularLineas(m[y[p]],2):"preferencia"==e?calcularLineas(m[y[p]],5):calcularLineas(m[y[p]]),l=coordenadasNiveles[c]+A,i=grillaSvg.alto-grillaSvg.labelSpace-b*infoDetails.verticalMargin;var d=d3.selectAll("g.info text").filter(function(e,t){for(var a=0,l=0;c>a;)l+=h[a].length,a++;return t==l+p});d.text(o[0]).attr("x",l).attr("y",i-(o.length-1)*infoDetails.verticalMargin).attr("class",function(){return currentSeccion+" "+a[c]+" "+y[p]}).attr("nivel",c).on("mouseover",function(){var e=$(this).attr("class").split(" ");d3.selectAll($("circle:not(."+e.join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+e.join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+e.join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)}),b++;for(var v=0,j=o.length-1;j>=1;j--)v=i-(o.length-j-1)*infoDetails.verticalMargin,d.append("tspan").text(o[j]).attr("x",l).attr("y",v).attr("class",currentSeccion+" "+a[c]+" "+y[p]).attr("nivel",c),b++}}}function generarInfoTextComuna(e){var t=$("circle.nivel_activo").attr("nivel");if("estadoCero"==e){generarInfoTextNiveles(e);var a=$("g.labels text[nivel='"+t+"'] tspan.nivelLink")[0];d3.select(a).style("text-decoration","none").style("font-weight","normal").on("click",function(){}),$("g.labels text[nivel='"+t+"']").show(),d3.selectAll("g.labels text[nivel='"+t+"']").attr("x",function(){return niveles[0].x0+circulo.margin}),d3.selectAll("g.labels text[nivel='"+t+"'] tspan").attr("x",function(){return niveles[0].x0+circulo.margin}),$("tspan.nivelLink").removeAttr("x"),$("g.labels text:not([nivel='"+t+"'])").hide()}else if("descripcion"==e){{var l=explicativos.secciones.comuna,i=Object.keys(l),n=0,r=0;descripcionesGroup.selectAll("text")}0!=descripcionesGroup.length&&descripcionesGroup.selectAll("text").remove(),descripcionesGroup.selectAll("text").data(i).enter().append("text");for(var c="",o=0;o<i.length;o++){c=l[i[o]][e];{var s=calcularLineas(c,5),u=s[s.length-1].split(" ");u[u.length-1]}n=niveles[2].x0,r=grillaSvg.alto/2-Math.floor(s.length/2)*infoDetails.verticalMargin;var d=d3.selectAll("g.descripciones text").filter(function(e,t){return t==o});d.text(s[0]).attr("x",n).attr("y",r).attr("class",currentSeccion+" "+i[o]+" descripcion animated fadeIn").attr("nivel",o);for(var v=0,g="",p=1;p<s.length;p++){v=r+infoDetails.verticalMargin*p,g=s[p];{d.append("tspan").text(g).attr("x",n).attr("y",v).attr("class",currentSeccion+" "+i[o]+" descripcion animated fadeIn").attr("nivel",o)}}}}else generarInfoTextNiveles(e),d3.selectAll("g.labels text[nivel='"+t+"']").attr("class",function(){return d3.select(this).attr("class")+" nivel_activo"}),d3.selectAll("g.info text[nivel='"+t+"']").attr("class",function(){return d3.select(this).attr("class")+" nivel_activo"}),$("g.info text[nivel='"+t+"']").show(),d3.selectAll("g.info text[nivel='"+t+"']").attr("x",function(){return niveles[0].x0+circulo.margin+grillaSvg.columnasPorNivel*(circulo.margin+circulo.radio)}),d3.selectAll("g.info text[nivel='"+t+"'] tspan").attr("x",function(){return niveles[0].x0+circulo.margin+grillaSvg.columnasPorNivel*(circulo.margin+circulo.radio)}),$("g.info text:not([nivel='"+t+"'])").hide()}function generarInfoText(e){switch($("g.info").show(),e="undefined"==typeof e?"estadoCero":e,infoGroup.selectAll("text").remove(),currentSeccion){case"landing":generarInfoTextLanding();break;case"general":generarInfoTextGeneral(e);break;case"niveles":generarInfoTextNiveles(e);break;case"comuna":generarInfoTextComuna(e)}}var currentSeccion=$("section.active").attr("id");$(".main").onepage_scroll({sectionContainer:"section",easing:"ease",animationTime:300,pagination:!0,updateURL:!1,beforeMove:function(){resetCambioSeccion()},afterMove:function(){switch(currentSeccion=$("section.active").attr("id"),$("section.active").removeClass("active"),$("section#"+currentSeccion).addClass("active"),$("#bajada").text(contenido.secciones[currentSeccion].bajada).fadeTo("fast",1),$("a.arrow").fadeIn(),$(".prev-section span.referencia").text(contenido.secciones[currentSeccion].anteriorSeccion).fadeIn(),$(".next-section span.referencia").text(contenido.secciones[currentSeccion].proximaSeccion).fadeIn(),currentSeccion){case"landing":showOneCirculito(),$(".prev-section").hide();break;case"general":$(".circulo").show(),$(".filtro").show(),$(".prev-section").show(),circuloMedio.attr("r")==circulo.radio?juntarCirculitos():hideOneCirculitoYJuntar();break;case"niveles":$(".filtro").show(),$(".circulo").show(),$("g.labels").show(),$("g.labels text").show(),$(".prev-section").show(),$("#radio-grados").parent().show(),separarCirculitos();break;case"comuna":$("#mapaCABA").show(),$(".filtro").show(),$("#viz-container").show(),$("#dropdown-nivel").show(),$(".prev-section").show(),generarInfoTextComuna("descripcion"),mostrarMapaComunas(),queue().defer(d3.json,"data/comunas.json").defer(d3.json,"data/data.json").await(ready);break;case"mapa":}generarInfoText()},loop:!1,keyboard:!0,responsiveFallback:!1,direction:"vertical"}),$(".next-section").click(function(){$(".main").moveDown()}),$(".prev-section").click(function(){$(".main").moveUp()});for(var svgGeneral=d3.select("svg#viz"),grilla=svgGeneral.append("g").attr("class","contenedor"),mapaComunas=svgGeneral.append("g").attr("id","mapaCABA"),json=function(){var e=null;return $.ajax({async:!1,global:!1,url:"data/data.json",dataType:"json",success:function(t){e=t}}),e}(),generalFemenino=Math.round(json.general.genero.femenino*totalCirculos/100),generalMasculino=Math.round(json.general.genero.masculino*totalCirculos/100),generalCABA=Math.round(json.general.procedencia.caba*totalCirculos/100),generalProvincia=Math.round(json.general.procedencia.provincia*totalCirculos/100),jsonNiveles=json.niveles,cantidadNiveles=Object.keys(jsonNiveles).length,niveles=[],i=0;cantidadNiveles>i;i++){var nivelActual=jsonNiveles[Object.keys(jsonNiveles)[i]],cantidadTotal=Math.round(nivelActual.total*totalCirculos/100),cantidadFemenino=Math.round(nivelActual.genero.femenino*cantidadTotal/100),cantidadMasculino=Math.round(nivelActual.genero.masculino*cantidadTotal/100),cantidadCABA=Math.round(nivelActual.procedencia.caba*cantidadTotal/100),cantidadProvincia=Math.round(nivelActual.procedencia.provincia*cantidadTotal/100),newNivel={x0:coordenadasNiveles[i],total:cantidadTotal,genero:{femenino:cantidadFemenino,masculino:cantidadMasculino},procedencia:{caba:cantidadCABA,provincia:cantidadProvincia}};niveles.push(newNivel)}var explicativos=function(){var e=null;return $.ajax({async:!1,global:!1,url:"data/explicativos.json",dataType:"json",success:function(t){e=t}}),e}(),contenido=function(){var e=null;return $.ajax({async:!1,global:!1,url:"data/contenido.json",dataType:"json",success:function(t){e=t}}),e}();for(i=0;i<grillaSvg.filasGeneral;i++)for(j=0;j<grillaSvg.columnasGeneral;j++){var grupo=grilla.append("g").attr("class","circulo animated fadeIn");grupo.append("circle").attr("fill",colores.neutro).attr("r",circulo.radio).attr("class",currentSeccion),grupo.append("rect").attr("width",2*circulo.radio+circulo.margin-circulo.radio).attr("height",2*circulo.radio+circulo.margin-circulo.radio).attr("fill","transparent").on("mouseover",function(){var e=$(this).parent().children("circle"),t=e.attr("class");d3.selectAll($("circle:not(."+t.split(" ").join(".")+")")).style("opacity",.2),d3.selectAll($("g.labels text:not(."+t.split(" ").join(".")+")")).style("opacity",.2),d3.selectAll($("g.info text:not(."+t.split(" ").join(".")+")")).style("opacity",.2)}).on("mouseout",function(){d3.selectAll("circle").style("opacity",1),d3.selectAll("text").style("opacity",1)})}var middleIndex=Math.floor(totalCirculos/2)-1,grupoCirculoMedio=d3.selectAll("g.circulo").filter(function(e,t){return t==middleIndex}),circuloMedio=d3.selectAll("circle").filter(function(e,t){return t==middleIndex}),posxMedio=circulo.posx+(circulo.margin+circulo.radio)*(middleIndex%grillaSvg.columnasGeneral+1),posyMedio=circulo.posy+(circulo.margin+circulo.radio)*(Math.floor(middleIndex/grillaSvg.columnasGeneral)+1);juntarCirculitos(),showOneCirculito();var infoGroup=svgGeneral.append("g").attr("class","info animated fadeInUp"),labelsGroup=svgGeneral.append("g").attr("class","labels animated fadeInDown"),descripcionesGroup=svgGeneral.append("g").attr("class","descripciones animated fadeInDown");generarInfoText(),$("#dropdown-nivel select").change(function(){resetRadios(),d3.selectAll("input[type=radio]").property("checked",!1),d3.selectAll("circle").attr("fill",colores.neutro).attr("class",function(){return currentSeccion+" nivel"+d3.select(this).attr("nivel")+" general"}),$("g.info").hide(),agregarNivelActivo(),mostrarMapaComunas(),queue().defer(d3.json,"data/comunas.json").defer(d3.json,"data/data.json").await(ready)});